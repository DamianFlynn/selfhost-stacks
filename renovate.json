{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": ["config:recommended"],
  "pinDigests": true,

  "enabledManagers": ["docker-compose"],
  "labels": ["renovate"],
  "vulnerabilityAlerts": { "labels": ["security"] },

  "packageRules": [
    /* ------- Label by update type ------- */
    {
      "description": "Label by update type",
      "matchUpdateTypes": ["major", "minor", "patch", "digest", "pin"],
      "addLabels": ["update:{{updateType}}"]
    },

    /* ------- Immich (server + ML) on v2.x, manual merge ------- */
    {
      "description": "Immich server requires manual review (v2.x only)",
      "matchDatasources": ["docker"],
      "matchPackagePatterns": [
        "^ghcr\\.io/immich-app/immich-server$",
        "^ghcr\\.io/immich-app/immich-machine-learning$"
      ],
      // Only track semver tags up to but not including v3
      "allowedVersions": ">=2.0.0 <3.0.0",
      "addLabels": ["stack:immich", "manual-merge"],
      "automerge": false
    },

    /* ------- LinuxServer code-server: versioning (stay on v4, parse upstream semver) ------- */
    {
      "description": "code-server versioning (use upstream semver, stay on v4)",
      "matchDatasources": ["docker"],
        "matchPackageNames": ["lscr.io/linuxserver/code-server"],
        "matchFileNames": ["**/stacks/code-server/**"],
        // Extract the upstream semver from tags like 4.104.2-ls294
        "extractVersion": "^(?<version>\\d+\\.\\d+\\.\\d+)",
        // Track v4.x only unless you opt in to v5+
        "allowedVersions": ">=4.0.0 <5.0.0"
      },

      /* ------- LinuxServer code-server: automerge for safe updates ------- */
    {
      "description": "code-server (safe, automerge minor/patch/digest)",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["lscr.io/linuxserver/code-server"],
      "matchFileNames": ["**/stacks/code-server/**"],
      "matchUpdateTypes": ["minor", "patch", "digest"],
      "addLabels": ["stack:code-server", "safe", "automerge"],
      "automerge": true,
      "platformAutomerge": true
    }


    /* ------- Valkey (unchanged) ------- */
    {
      "description": "valkey (redis) safe, automerge minor/patch/digest",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["docker.io/valkey/valkey"],
      "matchFileNames": ["**/stacks/immich/**"],
      "matchUpdateTypes": ["minor", "patch", "digest"],
      "addLabels": ["stack:immich", "component:valkey", "safe", "automerge"],
      "automerge": true,
      "platformAutomerge": true
    },

    /* ------- Immich Postgres stays pinned (ignore) ------- */
    {
      "description": "Keep Immich Postgres locked; manual bump only",
      "matchDatasources": ["docker"],
      "matchPackagePatterns": ["^ghcr\\.io/immich-app/postgres$"],
      "matchFileNames": ["**/stacks/immich/**"],
      "enabled": false,
      "addLabels": ["stack:immich", "component:postgres", "locked"]
    }
  ],

  "prHourlyLimit": 4,
  "stabilityDays": 1,
  "schedule": ["after 02:00 and before 06:00 on sunday"]
}
