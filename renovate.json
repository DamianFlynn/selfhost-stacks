{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": ["config:recommended"],

  // Pin image digests (replacement for the invalid ":pinDigests" preset)
  "pinDigests": true,

  "enabledManagers": ["docker-compose"],
  "labels": ["renovate"],

  // When GitHub raises a vulnerability alert that Renovate can fix,
  // label those PRs as "security".
  "vulnerabilityAlerts": {
    "labels": ["security"]
  },

  "packageRules": [
    /* ------- Update-type labelling ------- */
    {
      "description": "Label by update type",
      "matchUpdateTypes": ["major", "minor", "patch", "digest", "pin"],
      "addLabels": ["update:{{updateType}}"]
    },

    /* ------- Safe stacks (automerge) ------- */
    {
      "description": "lscr.io/linuxserver/code-server (safe, automerge minor/patch/digest)",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["lscr.io/linuxserver/code-server"],
      "matchFileNames": ["**/stacks/code-server/**"],
      "matchUpdateTypes": ["minor", "patch", "digest"],
      "addLabels": ["stack:code-server", "safe", "automerge"],
      "automerge": true,
      "platformAutomerge": true
    },
    {
      "description": "valkey (redis) safe, automerge minor/patch/digest",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["docker.io/valkey/valkey"],
      "matchFileNames": ["**/stacks/immich/**"],
      "matchUpdateTypes": ["minor", "patch", "digest"],
      "addLabels": ["stack:immich", "component:valkey", "safe", "automerge"],
      "automerge": true,
      "platformAutomerge": true
    },

    /* ------- Immich app images (manual merge) ------- */
    {
      "description": "Immich server requires manual review",
      "matchDatasources": ["docker"],
      "matchPackagePatterns": ["^ghcr\\.io/immich-app/immich-server$"],
      "matchFileNames": ["**/stacks/immich/**"],
      "addLabels": ["stack:immich", "component:server", "manual-merge"],
      "automerge": false
    },
    {
      "description": "Immich machine-learning requires manual review",
      "matchDatasources": ["docker"],
      "matchPackagePatterns": ["^ghcr\\.io/immich-app/immich-machine-learning$"],
      "matchFileNames": ["**/stacks/immich/**"],
      "addLabels": ["stack:immich", "component:ml", "manual-merge"],
      "automerge": false
    },

    /* ------- Immich Postgres stays pinned (ignore) ------- */
    {
      "description": "Keep Immich Postgres locked; manual bump only",
      "matchDatasources": ["docker"],
      "matchPackagePatterns": ["^ghcr\\.io/immich-app/postgres$"],
      "matchFileNames": ["**/stacks/immich/**"],
      "enabled": false,
      "addLabels": ["stack:immich", "component:postgres", "locked"]
    }
  ],

  "prHourlyLimit": 4,
  "stabilityDays": 1,
  "schedule": ["after 02:00 and before 06:00 on sunday"]
}
