# Karakeep Stack - Bookmark and content manager
# Self-hosted bookmarking service with AI-powered organization

name: karakeep


########################### NETWORKS
networks:
  default:
    driver: bridge
  t3_proxy:
     external: true


services:
  web:
    container_name: karakeep-web
    hostname: karakeep-web
    # renovate: datasource=docker depName=ghcr.io/karakeep-app/karakeep-web
    image: ghcr.io/karakeep-app/karakeep-web:0.30.0
    restart: unless-stopped
    volumes:
      - /mnt/fast/appdata/hoarder/karakeep/data:/data
    ports:
      - 127.0.0.1:3002:3000
    env_file:
      - .env
    environment:
      DATA_DIR: /data
      MEILI_ADDR: http://meilisearch:7700
      BROWSER_WEB_URL: http://chrome:9222
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    depends_on:
      - meilisearch
      - chrome
      - workers
    networks:
      - default
      - t3_proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.karakeep.rule=Host(`karakeep.${DOMAINNAME}`)
      - traefik.http.routers.karakeep.entrypoints=web,websecure
      - traefik.http.routers.karakeep.tls=true
      - traefik.http.routers.karakeep.tls.certresolver=dns-cloudflare
      - traefik.http.middlewares.karakeep.headers.SSLRedirect=true
      - traefik.http.middlewares.karakeep.headers.STSSeconds=315360000
      - traefik.http.middlewares.karakeep.headers.browserXSSFilter=true
      - traefik.http.middlewares.karakeep.headers.contentTypeNosniff=true
      - traefik.http.middlewares.karakeep.headers.forceSTSHeader=true
      - traefik.http.middlewares.karakeep.headers.SSLHost=${DOMAINNAME}
      - traefik.http.middlewares.karakeep.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.karakeep.headers.STSPreload=true
      - traefik.http.routers.karakeep.middlewares=karakeep@docker
      - traefik.http.services.karakeep.loadbalancer.server.port=3000

  workers:
    container_name: karakeep-workers
    hostname: karakeep-workers
    # renovate: datasource=docker depName=ghcr.io/karakeep-app/karakeep-workers
    image: ghcr.io/karakeep-app/karakeep-workers:0.30.0
    restart: unless-stopped
    volumes:
      - /mnt/fast/appdata/hoarder/karakeep/data:/data
    env_file:
      - .env
    environment:
      DATA_DIR: /data
      MEILI_ADDR: http://meilisearch:7700
      BROWSER_WEB_URL: http://chrome:9222
    depends_on:
      - meilisearch
      - chrome
    networks:
      - default

  mcp:
    container_name: karakeep-mcp
    hostname: karakeep-mcp
    # renovate: datasource=docker depName=ghcr.io/karakeep-app/karakeep-mcp
    image: ghcr.io/karakeep-app/karakeep-mcp:0.30.0
    restart: unless-stopped
    volumes:
      - /mnt/fast/appdata/hoarder/karakeep/data:/data
    env_file:
      - .env
    environment:
      DATA_DIR: /data
    depends_on:
      - web
    networks:
      - default
      - t3_proxy
    ports:
      - 127.0.0.1:3001:3001
    labels:
      - traefik.enable=true
      - traefik.http.routers.karakeep-mcp.rule=Host(`karakeep-mcp.${DOMAINNAME}`)
      - traefik.http.routers.karakeep-mcp.entrypoints=web,websecure
      - traefik.http.routers.karakeep-mcp.tls=true
      - traefik.http.routers.karakeep-mcp.tls.certresolver=dns-cloudflare
      - traefik.http.services.karakeep-mcp.loadbalancer.server.port=3001
  chrome:
    container_name: karakeep-chrome
    # renovate: datasource=docker depName=gcr.io/zenika-hub/alpine-chrome
    image: gcr.io/zenika-hub/alpine-chrome:124
    restart: unless-stopped
    command:
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
      - --hide-scrollbars
    networks:
      - default
      
  meilisearch:
    container_name: karakeep-meilisearch
    # renovate: datasource=docker depName=getmeili/meilisearch
    image: getmeili/meilisearch:v1.13.3
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MEILI_NO_ANALYTICS: "true"
    volumes:
      - /mnt/fast/appdata/hoarder/karakeep/meili:/meili_data
    networks:
      - default
